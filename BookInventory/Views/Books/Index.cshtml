@model List<BookInventory.Models.Book>
@using BookInventory.Helpers
@{
    var user = SessionHelper.GetUser(Context);
}

<h3>Books Inventory</h3>

<form method="get" class="mb-3 d-flex gap-2">
    <input name="search"
           value="@ViewBag.Search"
           placeholder="Search..."
           class="form-control w-25" />

    <button type="submit" class="btn btn-primary">
        Search
    </button>

    @if (!string.IsNullOrWhiteSpace(ViewBag.Search))
    {
        <a href="/Books/Index" class="btn btn-outline-secondary">
            Clear
        </a>
    }
</form>

@if (user.Role == "Admin")
{
    <a href="/Books/Create">Add Book</a>
}

<table class="table table-bordered mt-3" id="booksTable">
    <thead>
        <tr>
            <th>Cover</th>
            <th onclick="sortTable(1)">Title ⬍</th>
            <th onclick="sortTable(2)">Author ⬍</th>
            <th onclick="sortTable(3)">ISBN ⬍</th>
            <th onclick="sortTable(4)">Total Qty ⬍</th>
            <th>Locations</th>
            @if (user.Role == "Admin")
            {
                <th>Action</th>
            }
        </tr>
    </thead>

    <tbody id="booksBody">
        @foreach (var b in Model)
        {
            <tr>
                <td>
                    @if (!string.IsNullOrEmpty(b.ImageUrl))
                    {
                        <img src="@b.ImageUrl"
                             alt="Cover"
                             style="height:55px;width:auto;"
                             class="border rounded"
                             loading="lazy" />
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </td>
                <td>@b.Title</td>
                <td>@b.Author</td>
                <td>@b.ISBN</td>
                <td>@b.TotalQuantity</td>
                <td>
                    Almirah:@b.Locations.Almirah |
                    Bed:@b.Locations.Bed |
                    Box:@b.Locations.Box |
                    Other:@b.Locations.Other.Quantity
                    @if (!string.IsNullOrWhiteSpace(b.Locations.Other.Name))
                    {
                        <span> (@b.Locations.Other.Name)</span>
                    }
                </td>
                @if (user.Role == "Admin")
                {
                    <td>
                        <a href="/Books/Edit/@b.Id">Edit</a>
                    </td>
                }
            </tr>
        }
    </tbody>
</table>
<nav>
    <ul class="pagination" id="pagination"></ul>
</nav>
<script>
    const rowsPerPage = 10;
    let currentPage = 1;

    const table = document.getElementById("booksTable");
    const tbody = document.getElementById("booksBody");
    const rows = Array.from(tbody.rows);
    const pagination = document.getElementById("pagination");

    function renderTable() {
        tbody.innerHTML = "";

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        rows.slice(start, end).forEach(row => tbody.appendChild(row));
        renderPagination();
    }

    function renderPagination() {
        pagination.innerHTML = "";
        const pageCount = Math.ceil(rows.length / rowsPerPage);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;

            li.onclick = () => {
                currentPage = i;
                renderTable();
            };

            pagination.appendChild(li);
        }
    }

    function sortTable(colIndex) {
        const dir = table.getAttribute("data-sort") === "asc" ? "desc" : "asc";
        table.setAttribute("data-sort", dir);

        rows.sort((a, b) => {
            let x = a.cells[colIndex].innerText.trim();
            let y = b.cells[colIndex].innerText.trim();

            // 🔢 Numeric sorting (Total Qty column = index 4)
            if (colIndex === 4) {
                return dir === "asc"
                    ? Number(x) - Number(y)
                    : Number(y) - Number(x);
            }

            // 📘 ISBN sorting (remove hyphens, compare as string)
            if (colIndex === 3) {
                x = x.replace(/-/g, "");
                y = y.replace(/-/g, "");
            }

            // 🔤 Default string sort
            return dir === "asc"
                ? x.localeCompare(y)
                : y.localeCompare(x);
        });

        currentPage = 1;
        renderTable();
    }

    // Initial load
    renderTable();
</script>
