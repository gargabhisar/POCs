@model List<BookInventory.Models.Book>
@using BookInventory.Helpers
@{
    var user = SessionHelper.GetUser(Context);
}

<h3>Books Inventory</h3>

<form method="get" class="mb-3 d-flex gap-2">
    <input name="search"
           value="@ViewBag.Search"
           placeholder="Search..."
           class="form-control w-25" />

    <button type="submit" class="btn btn-primary">
        Search
    </button>

    @if (!string.IsNullOrWhiteSpace(ViewBag.Search))
    {
        <a href="/Books/Index" class="btn btn-outline-secondary">
            Clear
        </a>
    }

    <button type="button"
            class="btn btn-outline-secondary"
            onclick="clearSorting()">
        Clear Sort
    </button>
</form>

@if (user.Role == "Admin")
{
    <a href="/Books/Create">Add Book</a>
}

<div class="d-flex justify-content-between align-items-center mb-2">

    <div>
        <label class="me-2">Show</label>
        <select id="pageSizeSelect"
                class="form-select d-inline-block w-auto"
                onchange="changePageSize()">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="all">All</option>
        </select>
        <span class="ms-1">entries</span>
    </div>
    <nav>
        <ul class="pagination" id="pagination"></ul>
    </nav>
    <div id="paginationInfo" class="text-muted"></div>

</div>

<table class="table table-bordered mt-3" id="booksTable">
    <thead>
        <tr>
            <th>SerialNo</th>

            <th>Cover</th>

            <th onclick="sortTable(2)">
                Title <span id="sort-title">▲</span>
            </th>

            <th onclick="sortTable(3)">
                Author <span id="sort-author"></span>
            </th>

            <th onclick="sortTable(4)">
                ISBN <span id="sort-isbn"></span>
            </th>

            <th onclick="sortTable(5)">
                Total Qty <span id="sort-qty"></span>
            </th>

            <th>Locations</th>

            @if (user.Role == "Admin")
            {
                <th>Action</th>
            }
        </tr>
    </thead>


    <tbody id="booksBody">
        @foreach (var b in Model)
        {
            <tr>
                <td>@b.SerialNo</td>
                <td>
                    @if (!string.IsNullOrEmpty(b.ImageUrl))
                    {
                        <img src="@b.ImageUrl"
                             alt="Cover"
                             style="height:55px;width:auto;"
                             class="border rounded"
                             loading="lazy" />
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                </td>
                <td>@b.Title</td>
                <td>@b.Author</td>
                <td>@b.ISBN</td>
                <td>@b.TotalQuantity</td>
                <td>
                    Almirah:@b.Locations.Almirah |
                    Bed:@b.Locations.Bed |
                    Box:@b.Locations.Box |
                    Other:@b.Locations.Other.Quantity
                    @if (!string.IsNullOrWhiteSpace(b.Locations.Other.Name))
                    {
                        <span> (@b.Locations.Other.Name)</span>
                    }
                </td>
                @if (user.Role == "Admin")
                {
                    <td>
                        <a href="/Books/Edit/@b.Id"
                           onclick="saveCurrentPage()">
                            Edit
                        </a>
                    </td>
                }
            </tr>
        }
    </tbody>
</table>
<script>
    let rowsPerPage = 10;
    let currentPage = 1;
    let isInitialLoad = true;

    const PAGE_SIZE_KEY = "books_page_size";
    const CURRENT_PAGE_KEY = "books_current_page";

    const table = document.getElementById("booksTable");
    const tbody = document.getElementById("booksBody");
    const pagination = document.getElementById("pagination");

    const originalRows = Array.from(tbody.rows); // server order
    let rows = [...originalRows];

    /* =========================
       STATE HELPERS
    ========================= */

    function saveCurrentPage() {
        localStorage.setItem(CURRENT_PAGE_KEY, currentPage);
    }

    function clearSorting() {
        clearIcons();
        rows = [...originalRows];
        table.removeAttribute("data-sort");
        currentPage = 1;
        renderTable();
    }

    /* =========================
       PAGE SIZE
    ========================= */

    function changePageSize() {
        const select = document.getElementById("pageSizeSelect");
        const value = select.value;

        localStorage.setItem(PAGE_SIZE_KEY, value);

        rowsPerPage = value === "all"
            ? rows.length
            : parseInt(value);

        currentPage = 1;
        renderTable();
    }

    /* =========================
       RENDERING
    ========================= */

    function renderTable() {
        tbody.innerHTML = "";

        const totalRows = rows.length;
        const maxPage = Math.ceil(totalRows / rowsPerPage) || 1;

        if (currentPage > maxPage) {
            currentPage = maxPage;
        }

        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

        rows.slice(startIndex, endIndex)
            .forEach(row => tbody.appendChild(row));

        renderPagination();

        const info = document.getElementById("paginationInfo");
        info.innerText = totalRows === 0
            ? "No records found"
            : `Showing ${startIndex + 1}–${endIndex} of ${totalRows} books`;
    }

    function renderPagination() {
        pagination.innerHTML = "";

        const pageCount = rowsPerPage >= rows.length
            ? 1
            : Math.ceil(rows.length / rowsPerPage);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;

            li.onclick = () => {
                currentPage = i;
                renderTable();
            };

            pagination.appendChild(li);
        }
    }

    /* =========================
       SORTING
    ========================= */

    function clearIcons() {
        document.getElementById("sort-title").innerText = "";
        document.getElementById("sort-author").innerText = "";
        document.getElementById("sort-isbn").innerText = "";
        document.getElementById("sort-qty").innerText = "";
    }

    function sortTable(colIndex) {
        rows = [...rows];

        const dir = table.getAttribute("data-sort") === "asc" ? "desc" : "asc";
        table.setAttribute("data-sort", dir);

        clearIcons();

        const icon = dir === "asc" ? "▲" : "▼";
        if (colIndex === 2) document.getElementById("sort-title").innerText = icon;
        if (colIndex === 3) document.getElementById("sort-author").innerText = icon;
        if (colIndex === 4) document.getElementById("sort-isbn").innerText = icon;
        if (colIndex === 5) document.getElementById("sort-qty").innerText = icon;

        rows.sort((a, b) => {
            let x = a.cells[colIndex].innerText.trim();
            let y = b.cells[colIndex].innerText.trim();

            if (colIndex === 5) {
                return dir === "asc" ? Number(x) - Number(y) : Number(y) - Number(x);
            }

            if (colIndex === 4) {
                x = x.replace(/-/g, "");
                y = y.replace(/-/g, "");
            }

            return dir === "asc"
                ? x.localeCompare(y)
                : y.localeCompare(x);
        });

        if (!isInitialLoad) {
            currentPage = 1;
        }

        renderTable();
    }

    /* =========================
       RESTORE STATE
    ========================= */

    // Restore page size
    const savedPageSize = localStorage.getItem(PAGE_SIZE_KEY);
    const pageSizeSelect = document.getElementById("pageSizeSelect");

    if (savedPageSize) {
        pageSizeSelect.value = savedPageSize;
        rowsPerPage = savedPageSize === "all"
            ? rows.length
            : parseInt(savedPageSize);
    }

    // Restore page number
    const savedPage = localStorage.getItem(CURRENT_PAGE_KEY);
    if (savedPage) {
        currentPage = parseInt(savedPage);
    }

    /* =========================
       INITIAL LOAD
    ========================= */

    table.setAttribute("data-sort", "desc"); // force ASC
    rows = [...originalRows];
    sortTable(2); // Title

    isInitialLoad = false;
</script>
