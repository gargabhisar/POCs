@using BookInventory.Models
@{
    var conversations = ViewBag.Conversations as List<Conversation> ?? new();
    var selected = ViewBag.SelectedConversation as Conversation;
    var messages = ViewBag.Messages as List<Message> ?? new();
}

<div class="row" style="height:80vh">

    <!-- LEFT: Conversation list -->
    <div class="col-4 border-end overflow-auto">
        <h5 class="p-3 border-bottom">Inbox</h5>

        @if (!conversations.Any())
        {
            <div class="text-muted p-3">
                No conversations yet
            </div>
        }

        @foreach (var c in conversations)
        {
            var displayName =
            string.IsNullOrWhiteSpace(c.ContactName)
            ? c.PhoneNumber
            : c.ContactName;

            <a class="d-block p-3 border-bottom text-decoration-none inbox-item
                   @(selected?.Id == c.Id ? "active-chat" : "")"
               href="/Inbox/Index?conversationId=@c.Id">

                <div class="fw-bold">@displayName</div>
                <small class="text-muted">@c.LastMessageText</small>
            </a>
        }
    </div>

    <!-- RIGHT: Messages -->
    <div class="col-8 d-flex flex-column">

        @if (selected == null)
        {
            <div class="text-muted m-auto">
                Select a conversation
            </div>
        }
        else
        {
            var headerName =
            string.IsNullOrWhiteSpace(selected.ContactName)
            ? selected.PhoneNumber
            : selected.ContactName;

            <!-- Header -->
            <div class="border-bottom p-3 bg-light d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">@headerName</div>
                    <div class="text-muted small">@selected.PhoneNumber</div>
                </div>

                @if (ViewBag.SessionActive == true)
                {
                    <span class="badge bg-success">Session Active</span>
                }
                else
                {
                    <span class="badge bg-secondary">Session Expired</span>
                }
            </div>


            <!-- Messages -->
            <div id="messagesContainer"
                 class="flex-grow-1 overflow-auto p-3 bg-white">
                @await Html.PartialAsync("_Messages", messages)
            </div>

            <!-- Reply box -->
            <form method="post"
                  action="/Inbox/SendReply"
                  class="border-top p-3 bg-light">

                <input type="hidden"
                       name="conversationId"
                       value="@selected.Id" />

                @if (ViewBag.SessionActive == true)
                {
                    <!-- ✅ Session ACTIVE -->
                    <div class="input-group">
                        <textarea id="replyBox"
                          name="message"
                          class="form-control reply-box"
                          rows="1"
                          placeholder="Type a reply..."
                          required></textarea>

                        <button class="btn btn-success rounded-pill px-4"
                                type="submit">
                            Send
                        </button>
                    </div>
                }
                else
                {
                    <!-- 🔒 Session EXPIRED -->
                    <div class="alert alert-warning d-flex align-items-center gap-2 mb-0">
                        <span style="font-size:1.2rem;">⏰</span>
                        <div>
                            <strong>Session expired.</strong><br />
                            <small>You must send a template message to re-open this conversation.</small>
                        </div>
                    </div>
                }
            </form>
        }
    </div>
</div>

@if (selected != null)
{
    <script>
        const conversationId = "@selected.Id";

        async function refreshMessages() {
            try {
                const res = await fetch(
                    `/Inbox/Messages?conversationId=${conversationId}`
                );
                if (!res.ok) return;

                const html = await res.text();
                const container = document.getElementById("messagesContainer");
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;
            } catch { }
        }

        // Initial scroll
        setTimeout(() => {
            const el = document.getElementById("messagesContainer");
            if (el) el.scrollTop = el.scrollHeight;
        }, 200);

        // Refresh every 5 seconds
        setInterval(refreshMessages, 5000);

        // ===============================
        // MULTILINE REPLY (CONTROLLED)
        // ===============================
        const replyBox = document.getElementById("replyBox");

        if (replyBox) {
            // Auto-grow height
            replyBox.addEventListener("input", () => {
                replyBox.style.height = "auto";
                replyBox.style.height =
                    Math.min(replyBox.scrollHeight, 120) + "px";
            });

            // Ctrl + Enter → Send
            replyBox.addEventListener("keydown", function (e) {
                if (e.key === "Enter" && e.ctrlKey) {
                    e.preventDefault();
                    this.form.submit();
                }
            });
        }
    </script>
}

<style>
    .inbox-item {
        color: #000;
    }

        .inbox-item:hover {
            background-color: #f1f3f5;
        }

    .active-chat {
        background-color: #e7f1ff;
    }

    .reply-box {
        resize: none;
        overflow-y: auto;
        min-height: 40px;
        max-height: 120px;
        line-height: 1.4;
        border-radius: 20px;
        padding: 10px 14px;
    }
</style>
