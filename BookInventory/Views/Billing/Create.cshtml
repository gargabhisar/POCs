@model BookInventory.Models.Invoice
@{
    var books = ViewBag.Books as List<BookInventory.Models.Book>;
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
<div class="container mt-4">
    <div class="card shadow-sm">

        <div class="card-header">
            <h5 class="mb-0">Create Invoice</h5>
        </div>

        <div class="card-body">

            <form method="post">

                <!-- CUSTOMER DETAILS -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Customer Name</label>
                        <input asp-for="CustomerName" value="FName LName"
                               class="form-control"
                               required />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">
                            Customer Mobile <span class="text-danger">*</span>
                        </label>

                        <input asp-for="CustomerMobile"
                               class="form-control"
                               id="customerMobile"
                               maxlength="10"
                               inputmode="numeric"
                               value="9999999999"
                               placeholder="10-digit mobile number"
                               required />

                        <div class="invalid-feedback">
                            Mobile number must be exactly 10 digits.
                        </div>
                    </div>
                </div>

                <hr />

                <!-- INVOICE ITEMS -->
                <table class="table table-bordered" id="itemsTable">
                    <thead>
                        <tr>
                            <th>Book</th>
                            <th>MRP</th>
                            <th>Discount %</th>
                            <th>Final Price</th>
                            <th>Qty</th>
                            <th>Total</th>
                            <th>Remark</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <button type="button"
                        class="btn btn-outline-primary mb-3"
                        onclick="addRow()">
                    + Add Book
                </button>

                <div class="text-end mb-3">
                    <h5>
                        Grand Total:
                        ₹ <span id="grandTotal">0</span>
                    </h5>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">
                            Payment Mode <span class="text-danger">*</span>
                        </label>

                        <select asp-for="PaymentMode"
                                class="form-select"
                                id="paymentMode"
                                required>
                            <option value="">-- Select --</option>
                            <option value="Cash">Cash</option>
                            <option value="Online">Online</option>
                            <option value="NA">N/A</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-success">
                    Save & Generate Invoice
                </button>

            </form>

        </div>
    </div>
</div>

@section Scripts {

    <script>
        const books = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(books));

        function addRow() {
            const tbody = document.querySelector("#itemsTable tbody");
            const rowIndex = tbody.children.length;

            const row = document.createElement("tr");

                            row.innerHTML = `
        <td>
            <select name="Items[${rowIndex}].BookId"
                    class="form-select"
                    onchange="onBookChange(this)">
                <option value="">-- Select Book --</option>
                ${books.map(b =>
                    `<option value="${b.Id}"
                             data-mrp="${b.MRP}"
                             data-discount="${b.DiscountPercent}">
                        ${b.Title}
                    </option>`
                ).join("")}
            </select>
        </td>

        <td><input class="form-control" readonly /></td>
        <td>
              <input type="number"
                name="Items[${rowIndex}].DiscountPercent"
                class="form-control discount-input"
                min="0"
                max="100"
                step="1"
                value="0"
                oninput="validateDiscount(this); recalc()" />
        </td>
        <td><input class="form-control" readonly /></td>

        <td>
            <input type="number"
                   name="Items[${rowIndex}].Quantity"
                   class="form-control"
                   min="1"
                   value="1"
                   onchange="recalc()" />
        </td>

        <td class="lineTotal">0</td>

        <td>
            <input type="text"
                   name="Items[${rowIndex}].Remark"
                   class="form-control"
                   placeholder="Optional remark" />
        </td>

        <td>
            <button type="button"
                    class="btn btn-sm btn-danger"
                    onclick="this.closest('tr').remove(); recalc();">
                ✕
            </button>
        </td>
        `;

            tbody.appendChild(row);
        }

        function onBookChange(select) {
            const opt = select.selectedOptions[0];
            if (!opt) return;

            const row = select.closest("tr");

            const mrp = parseFloat(opt.dataset.mrp || 0);
            const discount = parseInt(opt.dataset.discount || 0, 10);

            row.children[1].querySelector("input").value = mrp;
            row.querySelector(".discount-input").value = discount;

            recalc();
        }

        function recalc() {
            let grandTotal = 0;

            document.querySelectorAll("#itemsTable tbody tr").forEach(row => {
                const mrp = parseFloat(row.children[1].querySelector("input").value || 0);
                const discount = parseInt(row.querySelector(".discount-input").value || 0, 10);
                const qty = parseInt(row.querySelector("input[name$='.Quantity']").value || 0, 10);

                const finalPrice = Math.ceil(mrp - (mrp * discount / 100));

                const total = finalPrice * qty;

                row.children[3].querySelector("input").value = finalPrice;
                row.querySelector(".lineTotal").innerText = total;

                grandTotal += total;
            });

            document.getElementById("grandTotal").innerText = grandTotal;
        }

        function validateDiscount(input) {
            let value = parseInt(input.value, 10);

            if (isNaN(value)) {
                value = 0;
            }

            if (value < 0) {
                value = 0;
            }

            if (value > 100) {
                value = 100;
            }

            input.value = value;
        }


    </script>
}

@if (Context.Request.Query["download"] == "1")
{
    <script>
        window.addEventListener("load", function () {
            // Delay ensures session is fully available
            setTimeout(function () {
                window.location.href = '@Url.Action("DownloadLastInvoice", "Billing")';
            }, 300);
        });
    </script>
}
<script>
    const mobileInput = document.getElementById("customerMobile");

    mobileInput.addEventListener("input", function () {
        // Allow digits only
        this.value = this.value.replace(/\D/g, "");

        // Validate length
        if (this.value.length !== 10) {
            this.classList.add("is-invalid");
        } else {
            this.classList.remove("is-invalid");
        }
    });

    // Prevent form submit if invalid
    document.querySelector("form").addEventListener("submit", function (e) {
        if (mobileInput.value.length !== 10) {
            mobileInput.classList.add("is-invalid");
            e.preventDefault();
        }
    });
</script>
