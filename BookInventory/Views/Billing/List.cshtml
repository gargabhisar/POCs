@model List<BookInventory.Models.Invoice>

<h3>Invoices</h3>

<div class="row mb-3 align-items-center">
    <div class="col-md-4">
        <input type="text"
               id="invoiceSearch"
               class="form-control"
               placeholder="Search by Invoice No, Name or Mobile"
               onkeyup="filterInvoices()" />
    </div>

    <div class="col-md-auto">
        <select id="pageSizeSelect"
                class="form-select"
                onchange="changePageSize()">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="all">All</option>
        </select>
    </div>

    <div class="col-md-auto text-muted" id="paginationInfo"></div>
</div>

<table class="table table-bordered table-hover" id="invoiceTable">
    <thead class="table-light">
        <tr>
            <th>Invoice No</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Mobile</th>
            <th>Total</th>
            <th>Payment Mode</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="invoiceTableBody">
        @foreach (var inv in Model)
        {
            <tr>
                <td>INV-@inv.InvoiceNo.ToString("D4")</td>
                <td>@inv.InvoiceDate.ToString("dd-MM-yyyy HH:mm")</td>
                <td>@inv.CustomerName</td>
                <td>@inv.CustomerMobile</td>
                <td>₹ @inv.GrandTotal.ToString("0.00")</td>
                <td>@inv.PaymentMode</td>
                <td>
                    <a class="btn btn-sm btn-outline-primary"
                       asp-action="Download"
                       asp-route-id="@inv.Id">
                        Download
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>

<nav>
    <ul class="pagination" id="pagination"></ul>
</nav>

<div id="noResults"
     class="text-center text-muted mt-3"
     style="display:none;">
    No invoices found.
</div>

<script>
    let rowsPerPage = 10;
    let currentPage = 1;

    const tableBody = document.getElementById("invoiceTableBody");
    const allRows = Array.from(tableBody.rows);
    let filteredRows = [...allRows];

    const pagination = document.getElementById("pagination");
    const paginationInfo = document.getElementById("paginationInfo");

    function renderTable() {
        tableBody.innerHTML = "";

        const totalRows = filteredRows.length;
        const start = (currentPage - 1) * rowsPerPage;
        const end = rowsPerPage === Infinity ? totalRows : start + rowsPerPage;

        filteredRows.slice(start, end).forEach(r => tableBody.appendChild(r));

        renderPagination();
        renderInfo(start, end, totalRows);
    }

    function renderPagination() {
        pagination.innerHTML = "";

        if (rowsPerPage === Infinity) return;

        const pageCount = Math.ceil(filteredRows.length / rowsPerPage);
        if (pageCount <= 1) return;

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;

            li.onclick = () => {
                currentPage = i;
                renderTable();
            };

            pagination.appendChild(li);
        }
    }

    function renderInfo(start, end, total) {
        if (total === 0) {
            paginationInfo.innerText = "No records";
            return;
        }

        paginationInfo.innerText =
            `Showing ${start + 1}–${Math.min(end, total)} of ${total} invoices`;
    }

    function filterInvoices() {
        const term = document.getElementById("invoiceSearch")
            .value.toLowerCase();

        filteredRows = allRows.filter(row => {
            const cells = row.cells;
            return (
                cells[0].innerText.toLowerCase().includes(term) || // Invoice
                cells[2].innerText.toLowerCase().includes(term) || // Name
                cells[3].innerText.toLowerCase().includes(term)    // Mobile
            );
        });

        document.getElementById("noResults").style.display =
            filteredRows.length === 0 ? "block" : "none";

        currentPage = 1;
        renderTable();
    }

    function changePageSize() {
        const value = document.getElementById("pageSizeSelect").value;
        rowsPerPage = value === "all" ? Infinity : parseInt(value);
        currentPage = 1;
        renderTable();
    }

    // INITIAL LOAD
    renderTable();
</script>